---
layout: page
title: Content Signature
---

# Content Signature HTTP Header

## Introduction

Whilst the IETF draft standard on [Signing HTTP Messages](http://tools.ietf.org/html/draft-cavage-http-signatures-04) brings a relatively simple approach to signing HTTP requests and responses, it is nevertheless too complex for the simple task of providing a signature over HTTP entity body content. In particular, if the signature in combination with the entity body is to be reused by the consumer of the HTTP request or response, then saving the signed headers including the (optional) `Digest` and the pseudo-header `(request-target)` is additional effort that, shows that concerns are being conflated: HTTP traffic on the one hand, signatures over the entity body on the other.

In time this may become a *proper* IETF RFC.

## Reference to `Content-MD5`

We therefore define a new HTTP entity header: `Content-Signature` which is analogous to the existing [Content-MD5](http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.15) header. Quoting the HTTP standard:

> The Content-MD5 entity-header field, as defined in RFC 1864 [23], is an MD5 digest of the entity-body for the purpose of providing an end-to-end message integrity check (MIC) of the entity-body. (Note: a MIC is good for detecting accidental modification of the entity-body in transit, but is not proof against malicious attacks.)
>
>        Content-MD5   = "Content-MD5" ":" md5-digest
>        md5-digest   = <base64 of 128 bit MD5 digest as per RFC 1864>
>
>The Content-MD5 header field MAY be generated by an origin server or client to function as an integrity check of the entity-body. Only origin servers or clients MAY generate the Content-MD5 header field; proxies and gateways MUST NOT generate it, as this would defeat its value as an end-to-end integrity check. Any recipient of the entity- body, including gateways and proxies, MAY check that the digest value in this header field matches that of the entity-body as received.
>
>The MD5 digest is computed based on the content of the entity-body, including any content-coding that has been applied, but not including any transfer-encoding applied to the message-body. If the message is received with a transfer-encoding, that encoding MUST be removed prior to checking the Content-MD5 value against the received entity.
>
>This has the result that the digest is computed on the octets of the entity-body exactly as, and in the order that, they would be sent if no transfer-encoding were being applied.
>
>HTTP extends RFC 1864 to permit the digest to be computed for MIME composite media-types (e.g., multipart/* and message/rfc822), but this does not change how the digest is computed as defined in the preceding paragraph.
>
>There are several consequences of this. The entity-body for composite types MAY contain many body-parts, each with its own MIME and HTTP headers (including Content-MD5, Content-Transfer-Encoding, and Content-Encoding headers). If a body-part has a Content-Transfer- Encoding or Content-Encoding header, it is assumed that the content of the body-part has had the encoding applied, and the body-part is included in the Content-MD5 digest as is -- i.e., after the application. The Transfer-Encoding header field is not allowed within body-parts .

## Reference to http-signatures

The draft standard describes the scheme for a `Signature` header as follows:

>Creating a Signature
>
>
>   In order to create a signature, a client MUST:
>
>   1.  Use the contents of the HTTP message, the `headers` value, and
>       the Signature String Construction algorithm to create the
>       signature string.
>
>   2.  The `algorithm` and key associated with `keyId` must then be used
>       to generate a digital signature on the signature string.
>
>   3.  The `signature` is then generated by base 64 encoding the output
>       of the digital signature algorithm.

## Synthesising `Content-Signature`

If we take the insights from both of these standards we can synthesise a new header, `Content-Signature`. 

The digest part of the signature is computed as per `Content-MD5` over the entity body bytes using the algorithm specified, before any transfer encoding (such as compression) is applied.

This digest is then signed and the data about the signature made available in the `Content-Signature` header which correspondingly requires the fields as defined:

* `algorithm`
* `keyId`
* `signature`

## Example

Let us assume that we have 2048 bit RSA [private](private_key.pem) and [public](public_key.pem) keys that we have generated. For the purposes of this exercise we will given the alias `lotteries-io`.

We also have a [file](example.txt) which will be the HTTP entity body. Its contents are:

```
This is an example.
```

We can compute the sha-256 hash over this using:
```
openssl dgst -sha256 example.txt | base64 > digest
```

This gives:

```
U0hBMjU2KGV4YW1wbGUudHh0KT0gYzgwYTk3MDQxZjE1YmExNjZiOWEzZThmYzJiMDk3MjZkNzc4
YmMzYmQ5MzM4ZDRiZWZlMzRiNDY3MDdlYmVlYwo=
```

Signing the file using our private key is done, for example, as follows:

```
openssl dgst -sha256 -sign private_key.pem example.txt | base64 > signature.base64
```

This gives:
```
UNtlSkR94FjgGstW238OcfxGSvEAtCJ8wikagpPdympgO7kjiM8PFpQ06vfKOtM3hGqMhGkrEI85
pErk94ou6E/pY8N7XGYgWdrvc3I1j0yaWAfUn3yCezl7slXfIs+Ph2zP+0LGgX3bVJrhYat+65bH
LC2Fr5q2aEBWCdSfe2U80NhzFk7zCZKFcMi2xftz+m/qcJ4uEq1knABo6JMAGukgwcrgiRmu+sBD
6OEZFm8pM5eoA/akzB+j5IkgkTK1bXryJb60DOKYiB01hvKdfkxMk+X335+/n5nAuhQr990dg3mw
zFaC/g19zjVkwQ87kKZn/yA2wEI5Ni6xFHpXCg==
```

Note that if we decode the base64 to raw bytes using `base64 --decode signature.base64 > signature.raw` we can then verify the signature using: 

```
openssl dgst -sha256 -verify public_key.pem -signature signature.raw example.txt
```

This gives:

```
Verified OK
```

Given all this, the `Content-Signature` header would now look like:

```
Content-Signature: keyId="lotteries-io",algorithm="rsa-sha256",signature="UNtlSkR94FjgGstW238OcfxGSvEAtCJ8wikagpPdympgO7kjiM8PFpQ06vfKOtM3hGqMhGkrEI85pErk94ou6E/pY8N7XGYgWdrvc3I1j0yaWAfUn3yCezl7slXfIs+Ph2zP+0LGgX3bVJrhYat+65bHLC2Fr5q2aEBWCdSfe2U80NhzFk7zCZKFcMi2xftz+m/qcJ4uEq1knABo6JMAGukgwcrgiRmu+sBD6OEZFm8pM5eoA/akzB+j5IkgkTK1bXryJb60DOKYiB01hvKdfkxMk+X335+/n5nAuhQr990dg3mwzFaC/g19zjVkwQ87kKZn/yA2wEI5Ni6xFHpXCg=="
```




